############################# Create Access Token ##################
- block:
 #   - name: Create access token with username/password
 #     uri:
 #       url: "https://netapp-cloud-account.auth0.com/oauth/token"
 #       method: POST
 #       body_format: json
 #       body:
 #         grant_type: password
 #         username: "{{ email_id }}"
 #         password: "{{ password }}"
 #         audience: "https://api.cloud.netapp.com"
 #         scope: profile
 #         client_id: QC3AgHk6qdbmC7Yyr82ApBwaaJLwRrNO
 #       headers:
 #         Content-Type: application/json
 #     register: connector_accesstoken
    #  when: connector_access == "password"
    - name: Create access token with refresh token
      uri:
        url: "https://netapp-cloud-account.auth0.com/oauth/token"
        method: POST
        body_format: json
        body:
          grant_type: refresh_token
          refresh_token: "{{ token }}"
          client_id: "Mu0V1ywgYteI6w1MbD15fKfVIUrNXGWC"
        headers:
          Content-Type: application/json
      register: connector_accesstoken
  #    when: connector_access == "refresh_token"
    - debug: var=connector_accesstoken
  rescue:
    - name: Failure 
      fail:
        msg: 
        - Create access token failed!
        - Possible troubleshooting steps:
        - 1. Check if API endpoint [https://netapp-cloud-account.auth0.com/oauth/token] is reachable 
        - 2. Check if provided username/password or refresh_token are correct
        - 3. Check if variables defined adhere to the guidelines

################### Create Snapmirror ###################
- block:
    - name: Create Snapmirror from On-Prem to CVO
      uri:
        url: "http://{{ connector_ips }}/occm/api/replication/vsa"
        method: POST
        body_format: json
        body:
          replicationRequest:
            sourceWorkingEnvironmentId: "{{ on_prem_id }}"
            destinationWorkingEnvironmentId: "{{ dest_cvo_id }}"
            sourceInterclusterLifIps: "{{ source_ic_lifs }}"
            destinationInterclusterLifIps: "{{ dest_ic_lifs }}"
            policyName: "{{ cvo_snap_policy }}"
            #maxTransferRate: "1024"
          replicationVolume:
            sourceSvmName: "{{ source_svm }}"
            sourceVolumeName: "{{ source_vol }}"
            destinationVolumeName: "{{ dest_vol }}"
            destinationAggregateName: "{{ dest_aggrg }} "
            #numOfDisksApprovedToAdd: 2
            advancedMode: false
        headers:
          Content-Type: application/json
          Authorization: "{{ connector_accesstoken.json.access_token }}"
      register: result
      failed_when:
        - ' "202" not in result.msg '
        
  rescue:
    - name: Failure
      fail:
        msg:
        - Snapmirror failed!
        - Possible troubleshooting steps:
        - 1. Check if API endpoint [https://netapp-cloud-account.auth0.com/oauth/token] is reachable
        - 2. Check if provided username/password or refresh_token are correct
        - 3. Check if variables defined adhere to the guidelines
